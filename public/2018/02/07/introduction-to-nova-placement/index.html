<!DOCTYPE html>
<html>
<head>
    

    
<!-- Tencent Speed -->
<script>var _speedMark = new Date()</script>
<!-- End Tencent Speed -->
<!-- Tencent Analysis -->
<script async src="//tajs.qq.com/stats?sId=62987721"></script>
<!-- End Tencent Analysis -->


    
<!-- Baidu Tongji -->
<script>var _hmt = _hmt || []</script>
<script async src="//hm.baidu.com/hm.js?eacacdefbe98e3b19a0b75b243dbeb5c"></script>
<!-- End Baidu Tongji -->




    <meta charset="utf-8">
    
    
    
    <title>认识Nova Placement | El barco | Just another mediocre programmer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Nova,OpenStack,Placement">
    <meta name="description" content="概览Nova在14.0.0，即Newton版本中引入了placement API，它是一个单独的REST API栈和数据模型，用于跟踪资源提供者（resouce provider）库存（inventory）和使用情况（usage），以及不同类别的资源（resource class）。比如，资源提供者可能是一个计算节点，一个共享存储池或者一个IP分配池。Placement服务跟踪每个资源提供者的库存">
<meta name="keywords" content="Nova,OpenStack,Placement">
<meta property="og:type" content="article">
<meta property="og:title" content="认识Nova Placement">
<meta property="og:url" content="http://elbarco.cn/2018/02/07/introduction-to-nova-placement/index.html">
<meta property="og:site_name" content="El barco">
<meta property="og:description" content="概览Nova在14.0.0，即Newton版本中引入了placement API，它是一个单独的REST API栈和数据模型，用于跟踪资源提供者（resouce provider）库存（inventory）和使用情况（usage），以及不同类别的资源（resource class）。比如，资源提供者可能是一个计算节点，一个共享存储池或者一个IP分配池。Placement服务跟踪每个资源提供者的库存">
<meta property="og:updated_time" content="2018-02-11T09:47:59.232Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="认识Nova Placement">
<meta name="twitter:description" content="概览Nova在14.0.0，即Newton版本中引入了placement API，它是一个单独的REST API栈和数据模型，用于跟踪资源提供者（resouce provider）库存（inventory）和使用情况（usage），以及不同类别的资源（resource class）。比如，资源提供者可能是一个计算节点，一个共享存储池或者一个IP分配池。Placement服务跟踪每个资源提供者的库存">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.6.10">
    <script>window.lazyScripts=[]</script>
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu"  >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Fan Zhang</h5>
          <a href="mailto:zh.f@outlook.com" title="zh.f@outlook.com" class="mail">zh.f@outlook.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/links"  >
                <i class="icon icon-lg icon-link"></i>
                Links
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/2hf" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">认识Nova Placement</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">认识Nova Placement</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-02-07T01:34:36.000Z" itemprop="datePublished" class="page-time">
  2018-02-07
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#概览"><span class="post-toc-number">1.</span> <span class="post-toc-text">概览</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考"><span class="post-toc-number">2.</span> <span class="post-toc-text">参考</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#深入阅读"><span class="post-toc-number">3.</span> <span class="post-toc-text">深入阅读</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#通用资源池（Generic-Resource-Pools）"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">通用资源池（Generic Resource Pools）</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#资源提供者–计算节点库存（Resource-Providers-Compute-Node-Inventory）"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">资源提供者–计算节点库存（Resource Providers - Compute Node Inventory）</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#资源提供者–分配（Resource-Providers-Allocations）"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">资源提供者–分配（Resource Providers - Allocations）</span></a></li></ol></li></ol>
        </nav>
    </aside>
    
<article id="post-introduction-to-nova-placement"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">认识Nova Placement</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-02-07 09:34:36" datetime="2018-02-07T01:34:36.000Z"  itemprop="datePublished">2018-02-07</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>Nova在14.0.0，即Newton版本中引入了placement API，它是一个单独的REST API栈和数据模型，用于跟踪资源提供者（resouce provider）库存（inventory）和使用情况（usage），以及不同类别的资源（resource class）。比如，资源提供者可能是一个计算节点，一个共享存储池或者一个IP分配池。Placement服务跟踪每个资源提供者的库存和使用情况，举个例子，创建在计算节点的实例作为资源消费者，可能需要来自计算节点提供的RAM、CPU资源，需要来自外部共享存储池中的磁盘资源，需要恩爱不IP资源池中的IP地址。</p>
<p>每种被消费的资源会按照类别进行标注和跟踪。Placement提供了一系列标准资源类别（如DISK_GB，MEMROY_MB和VCPU），还提供了按照需要定义资源的功能。</p>
<p>每个资源提供者此外还有一些特征（trait），用于描述资源提供者的某些特性。比如可用磁盘可能是SSD。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://specs.openstack.org/openstack/nova-specs/specs/newton/implemented/generic-resource-pools.html" target="_blank" rel="noopener">Generic Resource Pools</a></li>
<li><a href="https://specs.openstack.org/openstack/nova-specs/specs/newton/implemented/compute-node-inventory-newton.html" target="_blank" rel="noopener">Compute Node Inventory</a></li>
<li><a href="https://specs.openstack.org/openstack/nova-specs/specs/newton/implemented/resource-providers-allocations.html" target="_blank" rel="noopener">Resource Provider Allocations</a></li>
<li><a href="https://specs.openstack.org/openstack/nova-specs/specs/newton/implemented/resource-providers.html" target="_blank" rel="noopener">Resource Provider Base Models</a></li>
<li><a href="http://specs.openstack.org/openstack/nova-specs/specs/queens/approved/nested-resource-providers.html" target="_blank" rel="noopener">Nested Resource Providers</a></li>
<li><a href="http://specs.openstack.org/openstack/nova-specs/specs/ocata/implemented/custom-resource-classes.html" target="_blank" rel="noopener">Custom Resource Classes</a></li>
<li><a href="http://specs.openstack.org/openstack/nova-specs/specs/ocata/implemented/resource-providers-scheduler-db-filters.html" target="_blank" rel="noopener">Scheduler Filters in DB</a></li>
<li><a href="http://specs.openstack.org/openstack/nova-specs/specs/pike/approved/placement-claims.html" target="_blank" rel="noopener">Scheduler claiming resources to the Placement API</a></li>
<li><a href="http://specs.openstack.org/openstack/nova-specs/specs/pike/approved/resource-provider-traits.html" target="_blank" rel="noopener">The Traits API - Manage Traits with ResourceProvider</a></li>
<li><a href="https://specs.openstack.org/openstack/nova-specs/specs/queens/approved/request-traits-in-nova.html" target="_blank" rel="noopener">Request Traits During Scheduling</a></li>
</ul>
<h2 id="深入阅读"><a href="#深入阅读" class="headerlink" title="深入阅读"></a>深入阅读</h2><h3 id="通用资源池（Generic-Resource-Pools）"><a href="#通用资源池（Generic-Resource-Pools）" class="headerlink" title="通用资源池（Generic Resource Pools）"></a>通用资源池（Generic Resource Pools）</h3><p><a href="https://specs.openstack.org/openstack/nova-specs/specs/newton/implemented/generic-resource-pools.html" target="_blank" rel="noopener">bp传送门：&gt;&gt;&gt;</a></p>
<p>该bp中提到的问题是，由于历史遗留原因，Nova认为资源全部由计算节点提供，所以在报告某些资源使用的时候，Nova天真的通过数据库中不同的计算节点的数据，简单的累加去计算使用量和可用情况，明显使用情况和可提供的资源能力一定是会算错的……</p>
<p>所以，为了解决这个问题，该bp引入了Placement API，来管理和查询资源提供者的库存、分配记录（allocation records）和他们所协调的aggregate。</p>
<p>一个资源提供者会暴露一个或多个资源类型给多个消费该资源的消费者。资源提供者也不仅仅是共享内存。</p>
<p>Placement API可以允许管理（或服务）用户来创建资源提供者，更新这些提供者的容纳能力（capacity）和使用信息（usage），通过将资源池与一个或多个aggregates关联，指示哪些计算节点可以使用提供者的资源。</p>
<p>注：所有的API调用的代码实现在<code>/nova/api/openstack/placement/</code>下，因为这些调用是剥离出来的Placement REST API的一部分。此外，Placement API应该有单独的endpoint，并且与Nova API启动在不同的端口，由不同的服务提供服务。</p>
<p>我们可以看一下Placement API都有哪些，在代码<code>nova/api/openstack/placement/handler.py:52</code>中，可以看到路由的定义如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ROUTE_DECLARATIONS = &#123;</span><br><span class="line">    <span class="string">'/'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: root.home,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># NOTE(cdent): This allows '/placement/' and '/placement' to</span></span><br><span class="line">    <span class="comment"># both work as the root of the service, which we probably want</span></span><br><span class="line">    <span class="comment"># for those situations where the service is mounted under a</span></span><br><span class="line">    <span class="comment"># prefix (as it is in devstack). While weird, an empty string is</span></span><br><span class="line">    <span class="comment"># a legit key in a dictionary and matches as desired in Routes.</span></span><br><span class="line">    <span class="string">''</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: root.home,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/resource_classes'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: resource_class.list_resource_classes,</span><br><span class="line">        <span class="string">'POST'</span>: resource_class.create_resource_class</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/resource_classes/&#123;name&#125;'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: resource_class.get_resource_class,</span><br><span class="line">        <span class="string">'PUT'</span>: resource_class.update_resource_class,</span><br><span class="line">        <span class="string">'DELETE'</span>: resource_class.delete_resource_class,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/resource_providers'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: resource_provider.list_resource_providers,</span><br><span class="line">        <span class="string">'POST'</span>: resource_provider.create_resource_provider</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/resource_providers/&#123;uuid&#125;'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: resource_provider.get_resource_provider,</span><br><span class="line">        <span class="string">'DELETE'</span>: resource_provider.delete_resource_provider,</span><br><span class="line">        <span class="string">'PUT'</span>: resource_provider.update_resource_provider</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/resource_providers/&#123;uuid&#125;/inventories'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: inventory.get_inventories,</span><br><span class="line">        <span class="string">'POST'</span>: inventory.create_inventory,</span><br><span class="line">        <span class="string">'PUT'</span>: inventory.set_inventories,</span><br><span class="line">        <span class="string">'DELETE'</span>: inventory.delete_inventories</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/resource_providers/&#123;uuid&#125;/inventories/&#123;resource_class&#125;'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: inventory.get_inventory,</span><br><span class="line">        <span class="string">'PUT'</span>: inventory.update_inventory,</span><br><span class="line">        <span class="string">'DELETE'</span>: inventory.delete_inventory</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/resource_providers/&#123;uuid&#125;/usages'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: usage.list_usages</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/resource_providers/&#123;uuid&#125;/aggregates'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: aggregate.get_aggregates,</span><br><span class="line">        <span class="string">'PUT'</span>: aggregate.set_aggregates</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/resource_providers/&#123;uuid&#125;/allocations'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: allocation.list_for_resource_provider,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/allocations'</span>: &#123;</span><br><span class="line">        <span class="string">'POST'</span>: allocation.set_allocations,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/allocations/&#123;consumer_uuid&#125;'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: allocation.list_for_consumer,</span><br><span class="line">        <span class="string">'PUT'</span>: allocation.set_allocations_for_consumer,</span><br><span class="line">        <span class="string">'DELETE'</span>: allocation.delete_allocations,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/allocation_candidates'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: allocation_candidate.list_allocation_candidates,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/traits'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: trait.list_traits,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/traits/&#123;name&#125;'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: trait.get_trait,</span><br><span class="line">        <span class="string">'PUT'</span>: trait.put_trait,</span><br><span class="line">        <span class="string">'DELETE'</span>: trait.delete_trait,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/resource_providers/&#123;uuid&#125;/traits'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: trait.list_traits_for_resource_provider,</span><br><span class="line">        <span class="string">'PUT'</span>: trait.update_traits_for_resource_provider,</span><br><span class="line">        <span class="string">'DELETE'</span>: trait.delete_traits_for_resource_provider</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'/usages'</span>: &#123;</span><br><span class="line">        <span class="string">'GET'</span>: usage.get_total_usages,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以简单的做一个API调用看看效果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先得到auth token</span></span><br><span class="line">curl -d <span class="string">'&#123;"auth": &#123;"tenantName": "admin", "passwordCredentials": &#123;"username": "admin", "password": "1234qwer"&#125;&#125;&#125;'</span> \</span><br><span class="line">-H <span class="string">"Content-type: application/json"</span> \</span><br><span class="line">http://localhost:5000/v2.0/tokens</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"issued_at"</span>: <span class="string">"2018-02-07T07:40:07.000000Z"</span>, </span><br><span class="line">    <span class="string">"expires"</span>: <span class="string">"2018-02-07T08:40:07.000000Z"</span>, </span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"gAAAAABaeq1XrNDoU_F_iRk8uC0lOxYpyzLMW_YRs_ggJHuF1OpGHBN-pymQut-Bp2Er-J4XkYfQkMdJbRlBIBhq4wfhZMHZvag1itnL6Q-TSWhOn7uZpdQsYqqJDmwgtzCm-hcpg17IwN5FZSanCbcy6S96YZ0Zci5STWNka40861Mn8UQ2yRE"</span>, </span><br><span class="line">    <span class="string">"tenant"</span>: &#123;</span><br><span class="line">        <span class="string">"description"</span>: <span class="string">"admin tenant"</span>, </span><br><span class="line">        <span class="string">"enabled"</span>: <span class="literal">true</span>, </span><br><span class="line">        <span class="string">"id"</span>: <span class="string">"6387fc88b3064149a12eb5b58669e0b2"</span>, </span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"admin"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># token的获取方式，还可以用OSC命令：</span></span><br><span class="line">openstack token issue | grep <span class="string">' id'</span> | awk <span class="string">'&#123;print $4&#125;'</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#得到token之后，构造请求，查看resource providers list：</span></span><br><span class="line">curl -X GET /</span><br><span class="line">-H <span class="string">'x-auth-token:gAAAAABaeq1XrNDoU_F_iRk8uC0lOxYpyzLMW_YRs_ggJHuF1OpGHBN-pymQut-Bp2Er-J4XkYfQkMdJbRlBIBhq4wfhZMHZvag1itn17IwN5FZSanCbcy6S96YZ0Zci5STWNka40861Mn8UQ2yRE’ /</span></span><br><span class="line"><span class="string">http://192.168.122.105:8778/placement/resource_providers</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#得到resources providers list</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    "resource_providers": [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "generation": 30, </span></span><br><span class="line"><span class="string">            "uuid": "4cae2ef8-30eb-4571-80c3-3289e86bd65c", </span></span><br><span class="line"><span class="string">            "links": [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "href": "/placement/resource_providers/4cae2ef8-30eb-4571-80c3-3289e86bd65c", </span></span><br><span class="line"><span class="string">                    "rel": "self"</span></span><br><span class="line"><span class="string">                &#125;, </span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "href": "/placement/resource_providers/4cae2ef8-30eb-4571-80c3-3289e86bd65c/inventories", </span></span><br><span class="line"><span class="string">                    "rel": "inventories"</span></span><br><span class="line"><span class="string">                &#125;, </span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "href": "/placement/resource_providers/4cae2ef8-30eb-4571-80c3-3289e86bd65c/usages", </span></span><br><span class="line"><span class="string">                    "rel": "usages"</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            ], </span></span><br><span class="line"><span class="string">            "name": "f-packstack"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>其中的<code>generation</code>字段，是一个一致性视图的标志位，跟获取RP的inventories中的<code>resource_provider_generation</code>功能是相同的，下面来一个获取aggregate和inventories的示例，注意，aggregate的API是在1.1版本中实现的，所以注意在请求头指定<code>OpenStack-API-Version: placement 1.1</code>：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">curl -g -i -X GET http://192.168.122.105:8778/placement/resource_providers/4cae2ef8-30eb-4571-80c3-3289e86bd65c/aggregates \</span><br><span class="line">-H "User-Agent: python-novaclient" \</span><br><span class="line">-H "Accept: application/json" \</span><br><span class="line">-H "X-Auth-Token: gAAAAABaf5nafUZyFTl_pztozfB65wkP0c26HQqrxRgAiJGsxY8g743LxFOZEI3bF_l37xh0UajbF5nQ1kLYGAonOGphV4AivXgYMUOJ84uGrHjpC60NlmNzzQ3lJGVJb-pNxQw74WsMOc9I0D2B5Mzmf2OgDeictae5f0UFgTR9DFb_vaWCWQ4" \</span><br><span class="line">-H "OpenStack-API-Version: placement 1.1" </span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Fri, 15 Sep 2017 09:35:21 GMT</span><br><span class="line">Server: Apache/2.4.18 (Ubuntu)</span><br><span class="line">Content-Length: 18</span><br><span class="line">Content-Type: application/json</span><br><span class="line">OpenStack-API-Version: placement 1.1</span><br><span class="line">vary: OpenStack-API-Version</span><br><span class="line">x-openstack-request-id: req-ab28194f-8389-40a1-9a2b-a94dbc792573</span><br><span class="line">Connection: close</span><br><span class="line"> </span><br><span class="line">&#123;<span class="attr">"aggregates"</span>: []&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl -g -i -X GET http://192.168.122.105:8778/placement/resource_providers/4cae2ef8-30eb-4571-80c3-3289e86bd65c/inventories \</span><br><span class="line">-H "User-Agent: python-novaclient" \</span><br><span class="line">-H "Accept: application/json" \</span><br><span class="line">-H 'x-auth-token:gAAAAABae6lX26bp4PEVHCac0cjFnNl18W8DjeQKXDYvuKP4drRJ8t6DC-9uzcCm4E9Xf7NjqSqkRX6WGsE3qHmpAt7GmIu1SrLCtyEOVM2IQP5XLNrwMekGGrzQ_ADOaSTc9XpPpCYyYwzT-zCAvWG-T9T6Ip4l3zHWLwNBBPrm35gBZVZeslQ' \</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"resource_provider_generation"</span>: <span class="number">30</span>, </span><br><span class="line">    <span class="attr">"inventories"</span>: &#123;</span><br><span class="line">        <span class="attr">"VCPU"</span>: &#123;</span><br><span class="line">            <span class="attr">"allocation_ratio"</span>: <span class="number">16</span>, </span><br><span class="line">            <span class="attr">"total"</span>: <span class="number">4</span>, </span><br><span class="line">            <span class="attr">"reserved"</span>: <span class="number">0</span>, </span><br><span class="line">            <span class="attr">"step_size"</span>: <span class="number">1</span>, </span><br><span class="line">            <span class="attr">"min_unit"</span>: <span class="number">1</span>, </span><br><span class="line">            <span class="attr">"max_unit"</span>: <span class="number">128</span></span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="attr">"MEMORY_MB"</span>: &#123;</span><br><span class="line">            <span class="attr">"allocation_ratio"</span>: <span class="number">1.5</span>, </span><br><span class="line">            <span class="attr">"total"</span>: <span class="number">8095</span>, </span><br><span class="line">            <span class="attr">"reserved"</span>: <span class="number">512</span>, </span><br><span class="line">            <span class="attr">"step_size"</span>: <span class="number">1</span>, </span><br><span class="line">            <span class="attr">"min_unit"</span>: <span class="number">1</span>, </span><br><span class="line">            <span class="attr">"max_unit"</span>: <span class="number">8095</span></span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="attr">"DISK_GB"</span>: &#123;</span><br><span class="line">            <span class="attr">"allocation_ratio"</span>: <span class="number">1</span>, </span><br><span class="line">            <span class="attr">"total"</span>: <span class="number">49</span>, </span><br><span class="line">            <span class="attr">"reserved"</span>: <span class="number">0</span>, </span><br><span class="line">            <span class="attr">"step_size"</span>: <span class="number">1</span>, </span><br><span class="line">            <span class="attr">"min_unit"</span>: <span class="number">1</span>, </span><br><span class="line">            <span class="attr">"max_unit"</span>: <span class="number">49</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，如果一些非nova服务消耗了提供者的一些资源，字段<code>reserved</code>用于调整整个库存的总容量</p>
<p>举个例子，比如generation=10， A读到的是10，B也是10，但是B做了更新，generation=11，A更新时比对了一下generation=10 而非实际的11，则不允许更新，这又叫CAS，Compare and swap，有名的乐观锁技术——当多个线程尝试使用CAS同时更新同一个变量时，只有其中一个线程能更新变量的值，而其它线程都失败，失败的线程并不会被挂起，而是被告知这次竞争中失败，并可以再次尝试。</p>
<p>在这个bp的末尾，也提到了要补充一些OSC commands，以便方便用户操作，但是建议Placement API的调用全部通过RESTful API进行。查了一下，有一个Placement的<a href="https://github.com/openstack/osc-placement" target="_blank" rel="noopener">OSC plugin</a>，需要手动安装使用：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ pip install osc-placement</span><br></pre></td></tr></table></figure>
<p>有了OSC placement commands，我们不在需要使用curl命令模拟HTTP请求，并且可以非常轻松的进行操作：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@f-packstack ~(keystone_admin)]# openstack --debug resource provider list</span><br><span class="line">...</span><br><span class="line">http://192.168.122.105:8778 "GET /placement/resource_providers HTTP/1.1" 200 185</span><br><span class="line">RESP: [200] Date: Thu, 08 Feb 2018 05:59:56 GMT Server: Apache/2.4.6 (CentOS) OpenStack-API-Version: placement 1.0 vary: OpenStack-API-Version,Accept-Encoding x-openstack-request-id: req-c6077c19-ca05-4cab-95fa-6129ff989400 Content-Encoding: gzip Content-Length: 185 Keep-Alive: timeout=15, max=100 Connection: Keep-Alive Content-Type: application/json</span><br><span class="line">RESP BODY: &#123;"resource_providers": [&#123;"generation": 30, "uuid": "4cae2ef8-30eb-4571-80c3-3289e86bd65c", "links": [&#123;"href": "/placement/resource_providers/4cae2ef8-30eb-4571-80c3-3289e86bd65c", "rel": "self"&#125;, &#123;"href": "/placement/resource_providers/4cae2ef8-30eb-4571-80c3-3289e86bd65c/inventories", "rel": "inventories"&#125;, &#123;"href": "/placement/resource_providers/4cae2ef8-30eb-4571-80c3-3289e86bd65c/usages", "rel": "usages"&#125;], "name": "f-packstack"&#125;]&#125;</span><br><span class="line"></span><br><span class="line">GET call to placement for http://192.168.122.105:8778/placement/resource_providers used request id req-c6077c19-ca05-4cab-95fa-6129ff989400</span><br><span class="line">+--------------------------------------+-------------+------------+</span><br><span class="line">| uuid                                 | name        | generation |</span><br><span class="line">+--------------------------------------+-------------+------------+</span><br><span class="line">| 4cae2ef8-30eb-4571-80c3-3289e86bd65c | f-packstack |         30 |</span><br><span class="line">+--------------------------------------+-------------+------------+</span><br><span class="line">clean_up ListResourceProvider:</span><br><span class="line">END return value: 0</span><br></pre></td></tr></table></figure>
<p>在这个bp中只是引入了Placement API及其模型，接下来需要对使用Placement API进行资源跟踪，对现有的计算节点库存数据结构进行修改。所以有了下面的bp。</p>
<h3 id="资源提供者–计算节点库存（Resource-Providers-Compute-Node-Inventory）"><a href="#资源提供者–计算节点库存（Resource-Providers-Compute-Node-Inventory）" class="headerlink" title="资源提供者–计算节点库存（Resource Providers - Compute Node Inventory）"></a>资源提供者–计算节点库存（Resource Providers - Compute Node Inventory）</h3><p>该bp解决的问题是基础数据库模式的对齐以及nova.objects.ComputeNode对象模型需要的更改，以便从清单表中读取和写入清单/容量信息，而不是compute_nodes表。<br>比如，我们获取上面的resource provider的inventory：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@f-packstack ~(keystone_admin)]# openstack resource provider inventory list 4cae2ef8-30eb-4571-80c3-3289e86bd65c</span><br><span class="line">+----------------+------------------+----------+----------+-----------+----------+-------+</span><br><span class="line">| resource_class | allocation_ratio | max_unit | reserved | step_size | min_unit | total |</span><br><span class="line">+----------------+------------------+----------+----------+-----------+----------+-------+</span><br><span class="line">| VCPU           |             16.0 |      128 |        0 |         1 |        1 |     4 |</span><br><span class="line">| MEMORY_MB      |              1.5 |     8095 |      512 |         1 |        1 |  8095 |</span><br><span class="line">| DISK_GB        |              1.0 |       49 |        0 |         1 |        1 |    49 |</span><br><span class="line">+----------------+------------------+----------+----------+-----------+----------+-------+</span><br><span class="line">[root@f-packstack ~(keystone_admin)]# openstack resource provider inventory show 4cae2ef8-30eb-4571-80c3-3289e86bd65c MEMORY_MB</span><br><span class="line">+------------------+-------+</span><br><span class="line">| Field            | Value |</span><br><span class="line">+------------------+-------+</span><br><span class="line">| allocation_ratio | 1.5   |</span><br><span class="line">| max_unit         | 8095  |</span><br><span class="line">| reserved         | 512   |</span><br><span class="line">| step_size        | 1     |</span><br><span class="line">| min_unit         | 1     |</span><br><span class="line">| total            | 8095  |</span><br><span class="line">+------------------+-------+</span><br></pre></td></tr></table></figure>
<p>在<a href="https://blueprints.launchpad.net/nova/+spec/compute-node-inventory-newton" target="_blank" rel="noopener">bp传送门：&gt;&gt;&gt;</a>中提到目前仅仅实现了对核心资源类型（vcpus，memory_mb和local_gb）的数据迁移，正如上面看到的列表中的库存信息一样。至于PCI设备和NUMA拓扑，可能会在其他的bp中实现。</p>
<h3 id="资源提供者–分配（Resource-Providers-Allocations）"><a href="#资源提供者–分配（Resource-Providers-Allocations）" class="headerlink" title="资源提供者–分配（Resource Providers - Allocations）"></a>资源提供者–分配（Resource Providers - Allocations）</h3><p>在通用资源池中提到了两个分配相关的API，分别是设置资源分配和删除资源分配。</p>
<ul>
<li>PUT /allocations/{consumer_uuid} - 设置实例（即消费者）在计算节点（即resource provider）上获得的所有资源分配，API调用以事务方式写入所有的分配记录（每类正在使用的资源一条记录），确保没有部分更新</li>
<li>DELETE /allocations/{consumer_uuid} - 当实例终止时，resource tracker会调用该API，自动删除实例在计算节点上的分配记录。</li>
</ul>
<p>稍后我们再关注一下代码，先来用一下OSC command，查看不同flavor的主机及不同状态主机的资源分配情况：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@f-packstack ~(keystone_admin)]# nova list</span><br><span class="line">+--------------------------------------+---------------+---------+----------------------+-------------+-----------------+</span><br><span class="line">| ID                                   | Name          | Status  | Task State           | Power State | Networks        |</span><br><span class="line">+--------------------------------------+---------------+---------+----------------------+-------------+-----------------+</span><br><span class="line">| 8949377d-3590-4ea8-bebb-a78f9d593097 | cirrors-0.3.5 | SHUTOFF | -                    | Shutdown    | f-net=10.0.0.10 |</span><br><span class="line">| ba220145-4b16-4d83-b3c5-526dcf843da5 | f-测试主机     | SHUTOFF | -                    | Shutdown    | f-net=10.0.0.3  |</span><br><span class="line">| 1fedb34b-0aee-4cdc-bfac-1802f1769730 | test-01       | ERROR   | -                    | NOSTATE     | f-net=10.0.0.12 |</span><br><span class="line">| 82d5988a-79d1-43cf-924c-e9e76490807e | test-02       | BUILD   | block_device_mapping | NOSTATE     | f-net=10.0.0.9  |</span><br><span class="line">+--------------------------------------+---------------+---------+----------------------+-------------+-----------------+</span><br><span class="line">[root@f-packstack ~(keystone_admin)]# openstack resource provider allocation show ba220145-4b16-4d83-b3c5-526dcf843da5</span><br><span class="line">+--------------------------------------+------------+------------------------------------------------+</span><br><span class="line">| resource_provider                    | generation | resources                                      |</span><br><span class="line">+--------------------------------------+------------+------------------------------------------------+</span><br><span class="line">| 4cae2ef8-30eb-4571-80c3-3289e86bd65c |         30 | &#123;u'VCPU': 1, u'MEMORY_MB': 512, u'DISK_GB': 1&#125; |</span><br><span class="line">+--------------------------------------+------------+------------------------------------------------+</span><br><span class="line">[root@f-packstack ~(keystone_admin)]# openstack resource provider allocation show 1fedb34b-0aee-4cdc-bfac-1802f1769730</span><br><span class="line">+--------------------------------------+------------+-----------------+</span><br><span class="line">| resource_provider                    | generation | resources       |</span><br><span class="line">+--------------------------------------+------------+-----------------+</span><br><span class="line">| 4cae2ef8-30eb-4571-80c3-3289e86bd65c |         30 | &#123;u'DISK_GB': 1&#125; |</span><br><span class="line">+--------------------------------------+------------+-----------------+</span><br><span class="line">[root@f-packstack ~(keystone_admin)]# openstack resource provider allocation show 82d5988a-79d1-43cf-924c-e9e76490807e</span><br><span class="line">+--------------------------------------+------------+--------------------------------------------------+</span><br><span class="line">| resource_provider                    | generation | resources                                        |</span><br><span class="line">+--------------------------------------+------------+--------------------------------------------------+</span><br><span class="line">| 4cae2ef8-30eb-4571-80c3-3289e86bd65c |         31 | &#123;u'VCPU': 1, u'MEMORY_MB': 2048, u'DISK_GB': 20&#125; |</span><br><span class="line">+--------------------------------------+------------+--------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p><code>nova.compute.manager.ComputeManager#_build_resources</code></p>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        

        
        尊重原创，转载请标注作者及原文链接，感谢~
        
    </div>
    <footer>
        <a href="http://elbarco.cn">
            <img src="/img/avatar.jpg" alt="Fan Zhang">
            Fan Zhang
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-btn waves-light">Donate</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nova/">Nova</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenStack/">OpenStack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Placement/">Placement</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/&title=《认识Nova Placement》 — El barco&pic=http://elbarco.cn/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/&title=《认识Nova Placement》 — El barco&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《认识Nova Placement》 — El barco&url=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/&via=http://elbarco.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/01/24/how-scheduling-works-in-nova/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h5 class="title">Nova调度原理</h5>
      </a>
    </div>
  
</nav>



    


<section class="comments" id="comments">
    <div id="disqus_thread"></div>
    <script>
    var disqus_shortname = 'elbarco-cn';
    lazyScripts.push('//' + disqus_shortname + '.disqus.com/embed.js')
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>













</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        Thanks for donating
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="DonateQRCode">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">Wechat</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">Alipay</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <!-- div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        UV：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        PV：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
            <span>This blog is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div -->
    <div class="bottom">
    
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        UV：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        PV：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p><span>Fan Zhang &copy; 2016 - 2018</span>
            <span>
                
                <a href="http://www.miitbeian.gov.cn/publish/query/indexFirst.action" target="_blank">京ICP备16008405号-2</a><br>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/&title=《认识Nova Placement》 — El barco&pic=http://elbarco.cn/img/avatar.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/&title=《认识Nova Placement》 — El barco&source=" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《认识Nova Placement》 — El barco&url=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/&via=http://elbarco.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://elbarco.cn/2018/02/07/introduction-to-nova-placement/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


lazyScripts.push('//s95.cnzz.com/z_stat.php?id=1257688433&web_id=1257688433')

</script>

<script src="/js/main.min.js?v=1.6.10"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.6.10" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
